// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id          String   @id @default(cuid())
  fullName    String
  email       String   @unique
  phoneNumber String?  @unique
  password    String?  // Hashed with bcrypt - null if OAuth only
  
  // Profile
  location    String?
  profileImage String?
  dateOfBirth DateTime? // For age verification
  
  // Verification status
  emailVerified    DateTime?
  phoneVerified    DateTime?

  // Account status
  accountStatus    String   @default("active") // "active", "suspended", "closed"
  suspendedAt      DateTime?
  suspensionReason String?
  
  // Terms acceptance
  acceptedTermsAt     DateTime?
  acceptedTermsVersion String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  accounts         Account[]
  sessions         Session[]
  wallet           Wallet?
  transactions     Transaction[]
  baskets          Basket[]
  paymentMethods   PaymentMethod[]
  notifications    Notification[]
  auditLogs        AuditLog[]
  basketOrders     BasketOrder[]
  marketplaceOrders MarketplaceOrder[]
  deliveries       Delivery[]

  
  @@index([email])
  @@index([phoneNumber])
  @@index([accountStatus])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String  // "oauth", "credentials"
  provider          String  // "google", "apple", "credentials"
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  // Security tracking
  ipAddress    String?
  userAgent    String?
  country      String?  // Derived from IP for fraud detection
  city         String?
  deviceId     String?  // Device fingerprint
  
  createdAt    DateTime @default(now())
  lastUsedAt   DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([expires])
  @@index([sessionToken])
  @@map("sessions")
}

model VerificationToken {
  identifier String   // email or phone
  token      String   @unique
  type       String   // "email_verification", "phone_verification", "password_reset", "2fa_setup"
  expires    DateTime
  createdAt  DateTime @default(now())
  
  @@unique([identifier, token, type])
  @@index([expires])
  @@map("verification_tokens")
}

// ============================================
// WALLET & TRANSACTIONS
// ============================================

model Wallet {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Balances
  balance       Decimal  @db.Decimal(15, 2) @default(0)
  totalDeposits Decimal  @db.Decimal(15, 2) @default(0)
  totalSpent    Decimal  @db.Decimal(15, 2) @default(0)
  
  // Pending amounts (for holds/reversals)
  pendingDeposits   Decimal @db.Decimal(15, 2) @default(0)
  
  // Wallet status
  status        String   @default("active") // "active", "frozen", "closed"
  frozenAt      DateTime?
  frozenReason  String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  transactions  Transaction[]
  
  @@index([userId])
  @@index([status])
  @@map("wallets")
}

model Transaction {
  id          String            @id @default(cuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  walletId    String
  wallet      Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  // Transaction details
  type        TransactionType
  amount      Decimal           @db.Decimal(15, 2)
  fee         Decimal?          @db.Decimal(15, 2)
  netAmount   Decimal           @db.Decimal(15, 2) // amount - fee
  
  description String
  status      TransactionStatus @default(PENDING)
  failureReason String?
  
  // Balance tracking (for audit trail)
  balanceBefore Decimal         @db.Decimal(15, 2)
  balanceAfter  Decimal         @db.Decimal(15, 2)
  
  // Related entities
  basketId    String?
  basket      Basket?           @relation(fields: [basketId], references: [id])
  
  paymentMethodId String?
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  
  // Payment processor details
  processorTransactionId String? @unique // Paystack reference, Flutterwave tx_ref, etc.
  processorFee          Decimal? @db.Decimal(15, 2)
  processorResponse     Json?    // Full response from processor
  
  // Metadata
  metadata    Json?             // Additional transaction data
  
  // Timestamps
  initiatedAt DateTime          @default(now())
  completedAt DateTime?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  @@index([userId])
  @@index([walletId])
  @@index([basketId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([processorTransactionId])
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT              // User deposits money into wallet
  TRANSFER_TO_BASKET   // Move money from wallet to basket
  TRANSFER_FROM_BASKET // Move money from basket back to wallet
  MARKET_PURCHASE      // Purchase from marketplace
  REFUND               // Refund to wallet
  FEE                  // Platform fee
  REVERSAL             // Transaction reversal
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REVERSED
}

// ============================================
// BASKETS (Savings Goals)
// ============================================

model Basket {
  id              String        @id @default(cuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basket details
  name            String
  commodityType   String?       // "rice", "beans", "maize", etc.
  image           String?       // URL to commodity image
  description     String?       @db.Text
  category        String        @default("Foodstuff")
  
  // Goal tracking
  goalAmount      Decimal       @db.Decimal(15, 2)
  currentAmount   Decimal       @db.Decimal(15, 2) @default(0)
  targetDate      DateTime?     // Target deadline
  
  // Auto-save settings
  autoSaveEnabled Boolean       @default(false)
  autoSaveAmount  Decimal?      @db.Decimal(15, 2) // Amount to auto-transfer
  autoSaveFrequency String?     // "daily", "weekly", "monthly"
  nextAutoSaveAt  DateTime?
  
  regularTopUp    Decimal?      @db.Decimal(15, 2) // Suggested contribution
  
  // Status
  status          BasketStatus  @default(ACTIVE)
  
  // Milestones
  milestones      Json?         // Track progress milestones
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  completedAt     DateTime?     // When goal was reached
  pausedAt        DateTime?
  cancelledAt     DateTime?
  
  transactions    Transaction[]
  basketOrders    BasketOrder[]
  
  @@index([userId])
  @@index([status])
  @@index([nextAutoSaveAt])
  @@map("baskets")
}

enum BasketStatus {
  ACTIVE
  COMPLETED
  PAUSED
  CANCELLED
}

// ============================================
// BASKET ORDERS
// ============================================
model BasketOrder {
  id          String   @id @default(cuid())
  basketId    String
  userId      String
  commodityId String
  quantity    Int
  status      String   @default("PENDING") // PENDING, FULFILLED, CANCELLED
  requestedAt DateTime @default(now())
  deliveredAt DateTime?

  basket      Basket   @relation(fields: [basketId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  commodity   Commodity @relation(fields: [commodityId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([basketId])
  @@map("basket_orders")
}


// ============================================
// COMMODITIES
// ============================================
model Commodity {
  id          String   @id @default(cuid())
  
  // SKU & identity
  sku         String   @unique
  name        String
  category    String   // "Rice", "Oil", "Beans"
  brand       String?
  price       Decimal  @db.Decimal(15, 2)
  
  // Attributes
  unit        String   // "kg", "litre", "bag"
  size        Decimal  @db.Decimal(10, 2) // 5, 10, 25 etc
  image       String?
  description String? @db.Text
  
  // Status
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  basketOrders          BasketOrder[]
  marketplaceOrderItems MarketplaceOrderItem[]
  
  @@index([category])
  @@index([sku])
  @@map("commodities")
}

// ============================================
// ORDERS
// ============================================ 
model MarketplaceOrder {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status    String   @default("PENDING") // pending, fulfilled, cancelled
  total     Decimal  @db.Decimal(15, 2)
  deliveryLocation String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items     MarketplaceOrderItem[]
  
  @@index([userId])
  @@index([status])
  @@map("marketplace_orders")
}

// ============================================
// ORDER ITEMS
// ============================================ 
model MarketplaceOrderItem {
  id        String   @id @default(cuid())
  
  orderId     String
  commodityId String
  
  quantity  Int
  price     Decimal  @db.Decimal(15, 2)
  
  order     MarketplaceOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  commodity Commodity        @relation(fields: [commodityId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([commodityId])
  @@map("marketplace_order_items")
}

// ============================================
// DELIVERIES
// ============================================ 
model Delivery {
  id           String   @id @default(cuid())
  userId       String
  deliveryType String   // "BASKET", "MARKETPLACE"
  orderId      String
  status       String   @default("PENDING") // PENDING, IN_TRANSIT, DELIVERED, CANCELLED
  address      String
  courierInfo  Json?
  requestedAt  DateTime @default(now())
  dispatchedAt DateTime?
  deliveredAt  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([deliveryType])
  @@map("deliveries")
}


// ============================================
// PAYMENT METHODS (For deposits into wallet)
// ============================================

model PaymentMethod {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type            String   // "card", "bank_transfer", "ussd", "mobile_money"
  provider        String   // "paystack", "flutterwave", "stripe"
  
  // Card details (if applicable) - encrypted in app layer
  cardBrand       String?  // "visa", "mastercard", "verve"
  cardLast4       String?
  cardExpMonth    Int?
  cardExpYear     Int?
  cardBin         String?  // First 6 digits for fraud detection
  cardBank        String?  // Issuing bank
  cardCountry     String?  // Card country
  
  // Authorization details
  authorizationCode String? @unique // Paystack/Flutterwave auth code for recurring charges
  signature        String?
  
  // Bank transfer details (if applicable)
  bankName        String?
  accountNumber   String?  // Virtual account number for bank transfers
  
  // Status
  isPrimary       Boolean  @default(false)
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastUsedAt      DateTime?
  
  transactions    Transaction[]
  
  @@index([userId])
  @@index([authorizationCode])
  @@map("payment_methods")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      String   // "transaction", "basket_milestone", "security_alert", "promotion", "auto_save"
  title     String
  message   String   @db.Text
  link      String?  // Deep link to relevant page
  
  // Delivery channels
  sentViaEmail Boolean @default(false)
  sentViaSMS   Boolean @default(false)
  sentViaPush  Boolean @default(false)
  
  // Status
  read      Boolean  @default(false)
  readAt    DateTime?
  
  // Metadata
  metadata  Json?
  
  createdAt DateTime @default(now())
  
  @@index([userId, read])
  @@index([createdAt])
  @@index([type])
  @@map("notifications")
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?  // Null for system actions
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Action details
  action     String   // "login", "deposit", "withdrawal", "basket_create", "kyc_submit"
  category   String   // "auth", "financial", "profile", "security"
  severity   String   @default("info") // "info", "warning", "critical"
  
  // Context
  ipAddress  String
  userAgent  String?
  country    String?
  sessionId  String?
  
  // Request details
  endpoint   String?  // API endpoint called
  method     String?  // HTTP method
  
  // Details
  description String
  metadata    Json?    // Additional context
  oldValue    Json?    // For update actions
  newValue    Json?    // For update actions
  
  // Status
  success     Boolean  @default(true)
  errorMessage String?
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([category])
  @@index([severity])
  @@index([createdAt])
  @@map("audit_logs")
}

model RateLimitLog {
  id         String   @id @default(cuid())
  identifier String   // userId, IP, or API key
  action     String   // "api_call", "login_attempt", "withdrawal", "deposit"
  endpoint   String?  // Specific endpoint
  
  count      Int      @default(1)
  windowStart DateTime
  windowEnd   DateTime
  
  blocked    Boolean  @default(false)
  createdAt  DateTime @default(now())
  
  @@index([identifier, action, windowStart])
  @@index([createdAt])
  @@map("rate_limit_logs")
}

// ============================================
// SECURITY EVENTS
// ============================================

model SecurityEvent {
  id          String   @id @default(cuid())
  userId      String?
  
  eventType   String   // "failed_login", "password_change", "2fa_enabled", "suspicious_activity", "unusual_deposit"
  severity    String   // "low", "medium", "high", "critical"
  
  ipAddress   String
  userAgent   String?
  country     String?
  
  description String
  metadata    Json?
  
  // Response
  blocked     Boolean  @default(false)
  notified    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([eventType])
  @@index([severity])
  @@index([createdAt])
  @@map("security_events")
}